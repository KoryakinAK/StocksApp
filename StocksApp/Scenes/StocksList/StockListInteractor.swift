//
//  StockListInteractor.swift
//  StocksApp
//
//  Created by Alexey Koryakin on 20.03.2021.
//  Copyright (c) 2021 ___ORGANIZATIONNAME___. All rights reserved.
//
//  This file was generated by the Clean Swift Xcode Templates so
//  you can apply clean architecture to your iOS and Mac projects,
//  see http://clean-swift.com
//

import UIKit

protocol StockListBusinessLogic {
    func downloadStockDataFor(ticker: String)
    func setFavouriteStatusFor(ticker: String, to value: Bool)
    func getCurrentFavouriteStatusFor(ticker: String) -> Bool
}

protocol StockListDataStore {
    // var name: String { get set }
}

class StockListInteractor: StockListBusinessLogic, StockListDataStore {
    var presenter: StockListPresentationLogic?
    var worker: StockListWorker?

    func getCurrentFavouriteStatusFor(ticker: String) -> Bool {
        return UserDefaultsManager.sharedInstance().checkIfFavouritesContain(ticker: ticker)
    }

    func setFavouriteStatusFor(ticker: String, to value: Bool) {
        if value {
            UserDefaultsManager.sharedInstance().addToFavourites(ticker: ticker)
        } else {
            UserDefaultsManager.sharedInstance().removeFromFavourites(ticker: ticker)
        }
    }

    func downloadStockDataFor(ticker: String) {
        DispatchQueue.global(qos: .userInitiated).async {
            var resultShit: CompanyProfile!
            var resultMeme: Quote!
            let APICallsDispatGroup = DispatchGroup()
            APICallsDispatGroup.enter()
            StockAPIWorker.requestQuote(endpoint: StocksAPI.getCompanyProfile(ticker: ticker)) { (result: Result<CompanyProfile, Error>)  in
                switch result {
                case .success(let response):
                    print(response)
                    resultShit = response
                    APICallsDispatGroup.leave()
                //                        self.presenter?.presentLoadedStocksData(response: Stock(quote: Quote(c: 100, h: 100, l: 100, o: 100, pc: 100, t: 100), companyProfile: response))
                case .failure(let error):
                    //                        APICallsDispatGroup.leave()
                    // TODO: Уведомить пользователя об ошибке получения данных
                    break
                }
            }
            APICallsDispatGroup.enter()
            StockAPIWorker.requestQuote(endpoint: StocksAPI.getQuote(ticker: ticker)) { (result: Result<Quote, Error>)  in
                        switch result {
                        case .success(let response):
                            resultMeme = response
                            APICallsDispatGroup.leave()
                        case .failure(let error):
                            break
                        }
                    }
            APICallsDispatGroup.wait()
            DispatchQueue.main.async {
                self.presenter?.presentLoadedStocksData(response: Stock(quote: resultMeme, companyProfile: resultShit))
            }
        }
//        StockAPIWorker.requestQuote(endpoint: StocksAPI.getQuote(ticker: ticker)) { (result: Result<Quote, Error>)  in
//            switch result {
//            case .success(let response):
//                self.presenter?.presentLoadedStocksData(response: Stock(quote: response, ticker: ticker))
//            case .failure(let error):
//                break
//            }
//        }

        //        if let quoteResponse = quoteResponse, let companyProfileResponse = companyProfileResponse {
        //                self.presenter.sendToViewController(data: response)

    }
}
